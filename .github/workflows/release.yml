name: ğŸš€ Release Good Vibes

on:
  push:
    tags:
      - 'v*.*.*'

env:
  CABAL_VERSION: "3.10"
  BINARY_NAME: "good-vibes-scaner"

jobs:
  create-release:
    name: ğŸ¯ Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ·ï¸ Get tag name
      id: tag
      run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: ğŸ‰ Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        release_name: Good Vibes Scaner ${{ steps.tag.outputs.tag }} âœ¨
        body: |
          ## ğŸŒŸ What's New in This Vibe?
          
          Another release packed with good vibes and security improvements! ğŸš€
          
          ### âœ¨ Highlights
          - Bug fixes and performance improvements
          - Enhanced secret detection patterns
          - Better false positive filtering
          - Maintained those good vibes! ğŸ’«
          
          ### ğŸ“¦ Installation
          Download the binary for your platform below, or install via cabal:
          ```bash
          cabal install good-vibes-scaner
          ```
          
          ### ğŸ” Quick Start
          ```bash
          # Scan current directory with good vibes
          ./good-vibes-scaner --current-only
          ```
          
          ---
          *Built with ğŸ’– and Haskell magic*
        draft: false
        prerelease: false

  build-binaries:
    name: ğŸ—ï¸ Build ${{ matrix.os }} Binary
    needs: create-release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            asset-name: good-vibes-scaner-linux-x86_64
            ghc-version: '9.6.3'
          - os: macos-latest
            asset-name: good-vibes-scaner-macos-x86_64
            ghc-version: '9.6.3'
          - os: windows-latest
            asset-name: good-vibes-scaner-windows-x86_64.exe
            ghc-version: '9.6.3'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ—ï¸ Setup Haskell
      uses: haskell-actions/setup@v2
      with:
        ghc-version: ${{ matrix.ghc-version }}
        cabal-version: ${{ env.CABAL_VERSION }}
        
    - name: ğŸ“¦ Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cabal/packages
          ~/.cabal/store
          dist-newstyle
        key: ${{ runner.os }}-ghc-${{ matrix.ghc-version }}-cabal-${{ env.CABAL_VERSION }}-release-${{ hashFiles('**/*.cabal') }}
        
    - name: ğŸ”„ Update package index
      run: cabal update
      
    - name: ğŸ—ï¸ Build release binary
      run: |
        cabal configure --enable-optimization=2 --enable-executable-stripping --ghc-options="-O2"
        cabal build exe:good-vibes-scaner
        
    - name: ğŸ“‹ Locate binary (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        BINARY_PATH=$(find dist-newstyle -name "${{ env.BINARY_NAME }}" -type f -executable | head -1)
        echo "BINARY_PATH=$BINARY_PATH" >> $GITHUB_ENV
        cp "$BINARY_PATH" "${{ matrix.asset-name }}"
        
    - name: ğŸ“‹ Locate binary (Windows)
      if: runner.os == 'Windows'
      run: |
        $BINARY_PATH = Get-ChildItem -Path "dist-newstyle" -Name "${{ env.BINARY_NAME }}.exe" -Recurse | Select-Object -First 1
        $FULL_PATH = Join-Path "dist-newstyle" $BINARY_PATH.Name
        echo "BINARY_PATH=$FULL_PATH" | Out-File -Append $env:GITHUB_ENV
        Copy-Item $FULL_PATH "${{ matrix.asset-name }}"
      shell: powershell
      
    - name: ğŸ§ª Test binary
      run: |
        ./${{ matrix.asset-name }} --help
        
    - name: ğŸ“¦ Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./${{ matrix.asset-name }}
        asset_name: ${{ matrix.asset-name }}
        asset_content_type: application/octet-stream

  publish-hackage:
    name: ğŸ“š Publish to Hackage
    needs: [create-release, build-binaries]
    runs-on: ubuntu-latest
    if: github.repository_owner == 'svarog369'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ—ï¸ Setup Haskell
      uses: haskell-actions/setup@v2
      with:
        ghc-version: '9.6.3'
        cabal-version: ${{ env.CABAL_VERSION }}
        
    - name: ğŸ”„ Update package index
      run: cabal update
      
    - name: ğŸ“¦ Build and check package
      run: |
        cabal build
        cabal check
        cabal sdist
        
    - name: ğŸš€ Upload to Hackage (candidate)
      run: |
        cabal upload --publish dist-newstyle/sdist/good-vibes-scaner-*.tar.gz
      env:
        HACKAGE_USERNAME: ${{ secrets.HACKAGE_USERNAME }}
        HACKAGE_PASSWORD: ${{ secrets.HACKAGE_PASSWORD }}
      continue-on-error: true # Don't fail if Hackage upload fails
      
  notify-success:
    name: ğŸ‰ Spread the Good Vibes
    needs: [create-release, build-binaries]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: ğŸŠ Success notification
      run: |
        echo "ğŸ‰ Release completed successfully!"
        echo "âœ¨ Good vibes have been spread across all platforms!"
        echo "ğŸš€ Binaries are available for download"
        echo "ğŸ’« The secret-scanning vibes continue!"