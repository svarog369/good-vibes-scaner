name: ğŸš€ Good Vibes CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CABAL_VERSION: "3.10"

jobs:
  build-and-test:
    name: ğŸ§ª Build & Test (GHC ${{ matrix.ghc }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ghc: ['9.2.8', '9.4.7', '9.6.3']
        
    steps:
    - name: ğŸ“¥ Checkout code (spreading the good vibes)
      uses: actions/checkout@v5.0.0
      
    - name: ğŸ—ï¸ Setup Haskell (getting those vibes ready)
      uses: haskell-actions/setup@v2.7.6
      with:
        ghc-version: ${{ matrix.ghc }}
        cabal-version: ${{ env.CABAL_VERSION }}
        
    - name: ğŸ“¦ Cache dependencies (caching those good vibes)
      uses: actions/cache@v4.2.0
      with:
        path: |
          ~/.cabal/packages
          ~/.cabal/store
          dist-newstyle
        key: ${{ runner.os }}-ghc-${{ matrix.ghc }}-cabal-${{ env.CABAL_VERSION }}-${{ hashFiles('**/*.cabal', '**/cabal.project*') }}
        restore-keys: |
          ${{ runner.os }}-ghc-${{ matrix.ghc }}-cabal-${{ env.CABAL_VERSION }}-
          ${{ runner.os }}-ghc-${{ matrix.ghc }}-
          
    - name: ğŸ”„ Update package index (refreshing the vibes)
      run: cabal update
      
    - name: ğŸ”§ Configure project (aligning those vibes)
      run: cabal configure --enable-tests --enable-benchmarks --test-show-details=direct
      
    - name: ğŸ“‹ Show build plan (planning good vibes)
      run: cabal build --dry-run all
      
    - name: ğŸ—ï¸ Build dependencies (building up good vibes)
      run: cabal build --dependencies-only all
      
    - name: ğŸ”¨ Build project (manifesting good vibes)
      run: cabal build all
      
    - name: ğŸ§ª Run tests (testing those vibes)
      run: cabal test all --test-show-details=direct
      
    - name: ğŸ” Run the scanner on itself (dogfooding with good vibes)
      run: |
        cabal run good-vibes-scaner -- --current-only .
      continue-on-error: true
        
  lint-and-format:
    name: ğŸ§¹ Lint & Format Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v5.0.0
      
    - name: ğŸ—ï¸ Setup Haskell
      uses: haskell-actions/setup@v2.7.6
      with:
        ghc-version: '9.6.3'
        cabal-version: ${{ env.CABAL_VERSION }}
        
    - name: ğŸ” Basic syntax check (keeping vibes clean)
      run: |
        cabal build --dry-run all
        echo "âœ… Syntax check passed with good vibes!"
      
  security-check:
    name: ğŸ”’ Security Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v5.0.0
      
    - name: ğŸ—ï¸ Setup Haskell
      uses: haskell-actions/setup@v2.7.6
      with:
        ghc-version: '9.6.3'
        cabal-version: ${{ env.CABAL_VERSION }}
      
    - name: ğŸ›¡ï¸ Install modern cabal-audit (security vibes tool)
      run: |
        # Download the latest static executable
        curl -L -o cabal-audit https://github.com/MangoIV/cabal-audit/releases/download/nightly/cabal-audit
        chmod +x cabal-audit
        sudo mv cabal-audit /usr/local/bin/
      
    - name: ğŸ” Run security audit (keeping vibes secure)
      run: |
        # Run cabal-audit and capture the result
        if cabal-audit --json > audit_results.json 2>&1; then
          echo "âœ… Security audit passed with good vibes!"
        else
          echo "âš ï¸ Security advisories found, checking if they affect our code..."
          cat audit_results.json
          
          # Check for known false positives that don't affect our usage
          false_positives=0
          if grep -q "HSEC-2023-0007" audit_results.json; then
            echo "â„¹ï¸ HSEC-2023-0007 (readFloat): False positive - we don't use Numeric.readFloat"
            false_positives=$((false_positives + 1))
          fi
          if grep -q "HSEC-2024-0003" audit_results.json; then
            echo "â„¹ï¸ HSEC-2024-0003 (process): False positive - we only execute git, not .bat/.cmd files"
            false_positives=$((false_positives + 1))
          fi
          
          # Count total unique advisories in the output
          total_advisories=$(grep -o "HSEC-[0-9]\{4\}-[0-9]\{4\}" audit_results.json | sort -u | wc -l | tr -d ' ')
          
          if [ "$false_positives" -eq "$total_advisories" ] && [ "$total_advisories" -eq 2 ]; then
            echo "âœ… Only known false positives found - security audit passed!"
            exit 0
          else
            echo "âŒ Found $total_advisories advisories, but only $false_positives are known false positives"
            echo "âŒ New security vulnerabilities detected!"
            exit 1
          fi
        fi

  documentation:
    name: ğŸ“š Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v5.0.0
      
    - name: ğŸ—ï¸ Setup Haskell
      uses: haskell-actions/setup@v2.7.6
      with:
        ghc-version: '9.6.3'
        cabal-version: ${{ env.CABAL_VERSION }}
        
    - name: ğŸ“– Build documentation (documenting good vibes)
      run: |
        cabal configure --enable-documentation
        cabal haddock all
        
    - name: ğŸ“‹ Check README links (keeping links vibing)
      run: |
        # Basic check for broken markdown links
        grep -o '\[.*\]([^)]*)' README.md || echo "No markdown links found"

  release-check:
    name: ğŸš€ Release Readiness
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [build-and-test, lint-and-format]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v5.0.0
      
    - name: ğŸ—ï¸ Setup Haskell
      uses: haskell-actions/setup@v2.7.6
      with:
        ghc-version: '9.6.3'
        cabal-version: ${{ env.CABAL_VERSION }}
        
    - name: ğŸ“¦ Build release binary (preparing good vibes for release)
      run: |
        cabal configure --enable-optimization=2 --ghc-options="-O2"
        cabal build
        
    - name: ğŸ“‹ Package check (verifying release vibes)
      run: |
        cabal check
        cabal sdist
        
    - name: âœ¨ Success message
      run: |
        echo "ğŸ‰ All checks passed! Ready to spread good vibes! âœ¨"
        echo "ğŸ“¦ Build artifacts are ready for release"