name: ğŸš€ Good Vibes CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CABAL_VERSION: "3.10"

jobs:
  build-and-test:
    name: ğŸ§ª Build & Test (GHC ${{ matrix.ghc }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ghc: ['9.2.8', '9.4.7', '9.6.3']
        
    steps:
    - name: ğŸ“¥ Checkout code (spreading the good vibes)
      uses: actions/checkout@v4
      
    - name: ğŸ—ï¸ Setup Haskell (getting those vibes ready)
      uses: haskell-actions/setup@v2
      with:
        ghc-version: ${{ matrix.ghc }}
        cabal-version: ${{ env.CABAL_VERSION }}
        
    - name: ğŸ“¦ Cache dependencies (caching those good vibes)
      uses: actions/cache@v3
      with:
        path: |
          ~/.cabal/packages
          ~/.cabal/store
          dist-newstyle
        key: ${{ runner.os }}-ghc-${{ matrix.ghc }}-cabal-${{ env.CABAL_VERSION }}-${{ hashFiles('**/*.cabal', '**/cabal.project*') }}
        restore-keys: |
          ${{ runner.os }}-ghc-${{ matrix.ghc }}-cabal-${{ env.CABAL_VERSION }}-
          ${{ runner.os }}-ghc-${{ matrix.ghc }}-
          
    - name: ğŸ”„ Update package index (refreshing the vibes)
      run: cabal update
      
    - name: ğŸ”§ Configure project (aligning those vibes)
      run: cabal configure --enable-tests --enable-benchmarks --test-show-details=direct
      
    - name: ğŸ“‹ Show build plan (planning good vibes)
      run: cabal build --dry-run all
      
    - name: ğŸ—ï¸ Build dependencies (building up good vibes)
      run: cabal build --dependencies-only all
      
    - name: ğŸ”¨ Build project (manifesting good vibes)
      run: cabal build all
      
    - name: ğŸ§ª Run tests (testing those vibes)
      run: cabal test all --test-show-details=direct
      
    - name: ğŸ” Run the scanner on itself (dogfooding with good vibes)
      run: |
        cabal run good-vibes-scaner -- --current-only .
      continue-on-error: true
        
  lint-and-format:
    name: ğŸ§¹ Lint & Format Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ—ï¸ Setup Haskell
      uses: haskell-actions/setup@v2
      with:
        ghc-version: '9.6.3'
        cabal-version: ${{ env.CABAL_VERSION }}
        
    - name: ğŸ” Basic syntax check (keeping vibes clean)
      run: |
        cabal build --dry-run all
        echo "âœ… Syntax check passed with good vibes!"
      
  security-check:
    name: ğŸ”’ Security Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ—ï¸ Setup Haskell
      uses: haskell-actions/setup@v2
      with:
        ghc-version: '9.6.3'
        cabal-version: ${{ env.CABAL_VERSION }}
      
    - name: ğŸ›¡ï¸ Install modern cabal-audit (security vibes tool)
      run: |
        # Download the latest static executable
        curl -L -o cabal-audit https://github.com/MangoIV/cabal-audit/releases/download/nightly/cabal-audit
        chmod +x cabal-audit
        sudo mv cabal-audit /usr/local/bin/
      
    - name: ğŸ” Run security audit (keeping vibes secure)
      run: |
        cabal-audit --json --fail-on-warning || {
          echo "âš ï¸ Security vulnerabilities found - check the advisory database"
          exit 1
        }
        echo "âœ… Security audit passed with good vibes!"

  documentation:
    name: ğŸ“š Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ—ï¸ Setup Haskell
      uses: haskell-actions/setup@v2
      with:
        ghc-version: '9.6.3'
        cabal-version: ${{ env.CABAL_VERSION }}
        
    - name: ğŸ“– Build documentation (documenting good vibes)
      run: |
        cabal configure --enable-documentation
        cabal haddock all
        
    - name: ğŸ“‹ Check README links (keeping links vibing)
      run: |
        # Basic check for broken markdown links
        grep -o '\[.*\]([^)]*)' README.md || echo "No markdown links found"

  release-check:
    name: ğŸš€ Release Readiness
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [build-and-test, lint-and-format]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ—ï¸ Setup Haskell
      uses: haskell-actions/setup@v2
      with:
        ghc-version: '9.6.3'
        cabal-version: ${{ env.CABAL_VERSION }}
        
    - name: ğŸ“¦ Build release binary (preparing good vibes for release)
      run: |
        cabal configure --enable-optimization=2
        cabal build
        
    - name: ğŸ“‹ Package check (verifying release vibes)
      run: |
        cabal check
        cabal sdist
        
    - name: âœ¨ Success message
      run: |
        echo "ğŸ‰ All checks passed! Ready to spread good vibes! âœ¨"
        echo "ğŸ“¦ Build artifacts are ready for release"